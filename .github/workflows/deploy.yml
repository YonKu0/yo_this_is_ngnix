name: terraform-deploy

on:
  push:
    branches: [main, develop]

permissions:
  contents: read
  id-token: write

concurrency:
  group: terraform-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  TF_IN_AUTOMATION: "true"
  AWS_REGION: ${{ vars.AWS_REGION }}
  AWS_PLAN_ROLE_ARN: ${{ vars.AWS_PLAN_ROLE_ARN }}
  AWS_APPLY_ROLE_ARN: ${{ vars.AWS_APPLY_ROLE_ARN }}
  TF_WORKDIR: infra
  STATE_BUCKET: yo-this-is-ngnix-tfstate-${{ github.repository_id }}
  STATE_KEY: state/terraform.tfstate
  TF_VAR_region: ${{ vars.AWS_REGION }}
  ECR_REPOSITORY: yo-this-is-ngnix-app

jobs:
  build_image:
    name: build-and-push-image
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    outputs:
      image_uri: ${{ steps.meta.outputs.image_uri }}

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@7474bc4690e29a8392af63c5b98e7449536d5c3a # v4
        with:
          role-to-assume: ${{ env.AWS_PLAN_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Ensure ECR repository exists
        if: github.event_name == 'push'
        shell: bash
        run: |
          set -euo pipefail
          if aws ecr describe-repositories --repository-names "${ECR_REPOSITORY}" >/dev/null 2>&1; then
            echo "ECR repository exists: ${ECR_REPOSITORY}"
          else
            echo "Creating ECR repository: ${ECR_REPOSITORY}"
            aws ecr create-repository \
              --repository-name "${ECR_REPOSITORY}" \
              --image-scanning-configuration scanOnPush=true \
              --image-tag-mutability MUTABLE >/dev/null
          fi

      - name: Resolve image URI
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          ACCOUNT_ID="$(aws sts get-caller-identity --query Account --output text)"
          IMAGE_URI="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}:${GITHUB_SHA}"
          echo "image_uri=${IMAGE_URI}" >> "$GITHUB_OUTPUT"
          echo "IMAGE_URI=${IMAGE_URI}" >> "$GITHUB_ENV"

      - name: Login to Amazon ECR
        if: github.event_name == 'push'
        uses: aws-actions/amazon-ecr-login@062b18b96a7aff071d4dc91bc00c4c1a7945b076 # v2

      - name: Build image
        shell: bash
        run: |
          set -euo pipefail
          docker buildx build --platform linux/amd64 -f docker/Dockerfile -t "${IMAGE_URI}" --load .

      - name: Push image
        if: github.event_name == 'push'
        shell: bash
        run: |
          set -euo pipefail
          docker push "${IMAGE_URI}"

      - name: Tag latest on main
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        shell: bash
        run: |
          set -euo pipefail
          LATEST_URI="${IMAGE_URI%:*}:latest"
          docker tag "${IMAGE_URI}" "${LATEST_URI}"
          docker push "${LATEST_URI}"

  plan:
    name: fmt-validate-plan
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    needs: [build_image]
    env:
      TF_VAR_app_image_uri: ${{ needs.build_image.outputs.image_uri }}

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3
        with:
          terraform_wrapper: false

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@7474bc4690e29a8392af63c5b98e7449536d5c3a # v4
        with:
          role-to-assume: ${{ env.AWS_PLAN_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform fmt (check)
        run: terraform -chdir=${{ env.TF_WORKDIR }} fmt -check -recursive

      - name: Ensure state bucket exists
        shell: bash
        run: |
          set -euo pipefail
          if aws s3api head-bucket --bucket "${STATE_BUCKET}" 2>/dev/null; then
            echo "State bucket exists: ${STATE_BUCKET}"
          else
            echo "Creating state bucket: ${STATE_BUCKET}"
            if [ "${AWS_REGION}" = "us-east-1" ]; then
              aws s3api create-bucket --bucket "${STATE_BUCKET}"
            else
              aws s3api create-bucket --bucket "${STATE_BUCKET}" --create-bucket-configuration LocationConstraint="${AWS_REGION}"
            fi
            aws s3api put-bucket-encryption --bucket "${STATE_BUCKET}" --server-side-encryption-configuration '{
              "Rules": [{"ApplyServerSideEncryptionByDefault": {"SSEAlgorithm": "AES256"}}]
            }'
            aws s3api put-bucket-versioning --bucket "${STATE_BUCKET}" --versioning-configuration Status=Enabled
            aws s3api put-public-access-block --bucket "${STATE_BUCKET}" --public-access-block-configuration \
              BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true
          fi

      - name: Download prior state (if any)
        shell: bash
        run: |
          set -euo pipefail
          aws s3 cp "s3://${STATE_BUCKET}/${STATE_KEY}" "${TF_WORKDIR}/terraform.tfstate" || true

      - name: Terraform init
        run: terraform -chdir=${{ env.TF_WORKDIR }} init -input=false

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@90f302c255ef959cbfb4bd10581afecdb7ece3e6 # v4
        with:
          tflint_version: v0.55.1

      - name: TFLint
        shell: bash
        run: |
          set -euo pipefail
          tflint --chdir="${TF_WORKDIR}" --init
          tflint --chdir="${TF_WORKDIR}"

      - name: tfsec
        uses: aquasecurity/tfsec-action@b466648d6e39e7c75324f25d83891162a721f2d6 # v1.0.3
        with:
          working_directory: ${{ env.TF_WORKDIR }}
          version: v1.28.14
          additional_args: --no-color --force-all-dirs
          soft_fail: true

      - name: Terraform validate
        run: terraform -chdir=${{ env.TF_WORKDIR }} validate

      - name: Terraform plan
        run: terraform -chdir=${{ env.TF_WORKDIR }} plan -input=false -out=tfplan

      - name: Upload plan artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: tfplan
          path: |
            ${{ env.TF_WORKDIR }}/tfplan

  apply:
    name: apply (production gate)
    runs-on: ubuntu-latest
    needs: [plan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: ${{ steps.deployment_url.outputs.url }}

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3
        with:
          terraform_wrapper: false

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@7474bc4690e29a8392af63c5b98e7449536d5c3a # v4
        with:
          role-to-assume: ${{ env.AWS_APPLY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Ensure state bucket exists
        shell: bash
        run: |
          set -euo pipefail
          aws s3api head-bucket --bucket "${STATE_BUCKET}" 2>/dev/null || {
            echo "State bucket missing; run plan job first."
            exit 1
          }

      - name: Download prior state (if any)
        shell: bash
        run: |
          set -euo pipefail
          aws s3 cp "s3://${STATE_BUCKET}/${STATE_KEY}" "${TF_WORKDIR}/terraform.tfstate" || true

      - name: Download plan artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: tfplan
          path: ${{ env.TF_WORKDIR }}

      - name: Terraform init
        run: terraform -chdir=${{ env.TF_WORKDIR }} init -input=false

      - name: Terraform apply (exact tfplan artifact)
        run: terraform -chdir=${{ env.TF_WORKDIR }} apply -input=false tfplan

      - name: Resolve deployment URL
        id: deployment_url
        shell: bash
        run: |
          set -euo pipefail
          APP_URL="$(terraform -chdir=${TF_WORKDIR} output -raw app_url)"
          echo "url=${APP_URL}" >> "$GITHUB_OUTPUT"
          echo "### Deployment URL" >> "$GITHUB_STEP_SUMMARY"
          echo "${APP_URL}" >> "$GITHUB_STEP_SUMMARY"

      - name: Smoke test deployment response
        shell: bash
        run: |
          set -euo pipefail
          APP_URL="${{ steps.deployment_url.outputs.url }}"
          for i in $(seq 1 30); do
            BODY="$(curl -fsSL --max-time 15 "${APP_URL}" || true)"
            if printf '%s\n' "${BODY}" | grep -Fxq "yo this is nginx"; then
              echo "Smoke test passed for ${APP_URL}"
              exit 0
            fi
            echo "Smoke test attempt ${i}/30 failed, retrying in 10s..."
            sleep 10
          done
          echo "Smoke test failed for ${APP_URL}. Last response: ${BODY}"
          exit 1

      - name: Upload updated state
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "${TF_WORKDIR}/terraform.tfstate" ]; then
            aws s3 cp "${TF_WORKDIR}/terraform.tfstate" "s3://${STATE_BUCKET}/${STATE_KEY}"
          else
            echo "No local state file to upload (backend may write directly to S3)."
          fi
